var PharaohLoginLayer = cc.class("PharaohLoginLayer", cc.Layer, {

    ACCOUNT_LOCAL: [
        {
            userId: "49941",
            userName: "TESTGAME001",
            userEmail: "lele001@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51275",
            userName: "lelelele001",
            userEmail: "lelelele001@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51276",
            userName: "lelelele002",
            userEmail: "lelelele002@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51277",
            userName: "lelelele003",
            userEmail: "lelelele003@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51278",
            userName: "lelelele004",
            userEmail: "lelelele004@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51279",
            userName: "lelelele005",
            userEmail: "lelelele005@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51280",
            userName: "lelelele006",
            userEmail: "lelelele006@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51281",
            userName: "lelelele007",
            userEmail: "lelelele007@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51282",
            userName: "lelelele008",
            userEmail: "lelelele008@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51283",
            userName: "lelelele009",
            userEmail: "lelelele009@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51284",
            userName: "lelelele0010",
            userEmail: "lelelele0010@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51285",
            userName: "lelelele0011",
            userEmail: "lelelele0011@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51286",
            userName: "lelelele0012",
            userEmail: "lelelele0012@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51287",
            userName: "lelelele0013",
            userEmail: "lelelele0013@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51288",
            userName: "lelelele0014",
            userEmail: "lelelele0014@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51289",
            userName: "lelelele0015",
            userEmail: "lelelele0015@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51290",
            userName: "lelelele0016",
            userEmail: "lelelele0016@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51291",
            userName: "lelelele0017",
            userEmail: "lelelele0017@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51292",
            userName: "lelelele0018",
            userEmail: "lelelele0018@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51293",
            userName: "lelelele0019",
            userEmail: "lelelele0019@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "51294",
            userName: "lelelele0020",
            userEmail: "lelelele0020@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52295",
            userName: "thunto1",
            userEmail: "thunto1@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52296",
            userName: "thunto2",
            userEmail: "thunto2@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52297",
            userName: "thunto3",
            userEmail: "thunto3@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52298",
            userName: "thunto4",
            userEmail: "thunto4@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52299",
            userName: "thunto5",
            userEmail: "thunto5@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52300",
            userName: "thunto6",
            userEmail: "thunto6@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52301",
            userName: "thunto7",
            userEmail: "thunto7@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52302",
            userName: "thunto8",
            userEmail: "thunto8@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52303",
            userName: "thunto9",
            userEmail: "thunto9@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
        {
            userId: "52304",
            userName: "thunto10",
            userEmail: "thunto10@abc.net",
            userPass: "12-0D-1B-68-A0-99-F9-62-CD-69-87-AC-07-88-A2-EE-C3-71-E1-8E"
        },
    ],

    ACCOUNT_ONLINE: [
        {
            userId: "1607043",
            userName: "tester011",
            userEmail: "tester011@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "1607071",
            userName: "tester013",
            userEmail: "tester013@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "1607076",
            userName: "tester014",
            userEmail: "tester014@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "1607082",
            userName: "tester015",
            userEmail: "tester015@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "1607095",
            userName: "tester016",
            userEmail: "tester016@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "2305305",
            userName: "tester017",
            userEmail: "tester017@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
        {
            userId: "2374934",
            userName: "tester018",
            userEmail: "tester018@abc.net",
            userPass: "123@abc",
            userPassHash: "dfa64301bee6fc4952c3e30542aaaed1"
        },
    ],

    TABS: {
        LOCAL: 0,
        ONLINE: 1,
    },

    TAB_COLOR_NORMAL: cc.hexToColor("#2f2f2f"),
    TAB_COLOR_SELECTED: cc.hexToColor("#f1c40f"),

    TEXT_COLOR_INPUT: cc.color.BLACK,
    TEXT_COLOR_PLACEHOLDER: cc.hexToColor("#D1D1D1"),

    ACC_NAME_COLOR_LOCAL: cc.hexToColor("#f39c12"),
    ACC_NAME_COLOR_ONLINE: cc.hexToColor("#2ecc71"),

    ctor: function (onBetaSelected = null, onOnlineSelected = null) {
        this._super();

        this.isBusy = false;

        this.isWindows = cc.sys.os === cc.sys.OS_WINDOWS;
        this.isTemplate = portalManager !== undefined && portalManager.isTemplate !== undefined && portalManager.isTemplate();

        this.usePortalLogin = !this.isTemplate;

        this.onBetaSelected = onBetaSelected;
        this.onOnlineSelected = onOnlineSelected;

        // reset overriden funcs

        if (portalHelper._getLanguageStr !== undefined) {
            portalHelper.getLanguageStr = portalHelper._getLanguageStr;
            delete portalHelper._getLanguageStr;
        }
        if (portalHelper._getLanguageType !== undefined) {
            portalHelper.getLanguageType = portalHelper._getLanguageType;
            delete portalHelper._getLanguageType;
        }

        this.resourceRoot = "res/dev";

        let jsonFile = this.resourceRoot + "/portal_login.json";

        this.root = ccs.load(jsonFile).node;
        NodeUtils.fixTextLayout(this.root);
        this.addChild(this.root);

        let bg = this.root.getChildByName("bg");
        bg.setContentSize(cc.size(cc.visibleRect.width, cc.visibleRect.height));

        this.initButtons(this.root);
        this.initPanelLocal(this.root);
        this.initPanelOnline(this.root);
        this.initPanelSetting(this.root);

        this.initTabs(this.root);
    },

    onEnter: function () {
        this._super();

        this.loadAccount(this.listAccountLocal, this.ACCOUNT_LOCAL, true);
        this.loadAccount(this.listAccountOnline, this.ACCOUNT_ONLINE);
    },

    initPanelLocal: function (node) {

        this.panelLocal = node.getChildByName("panel_local");
        this.panelLocal.setVisible(false);

        this.buttonLocal = node.getChildByName("button_local");
        this.buttonLocal.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 1)) {
                this.selectTab(this.TABS.LOCAL);
            }
        });

        this.buttonLocalText = this.buttonLocal.getChildByName("text");

        this.listAccountLocal = this.panelLocal.getChildByName("list_accounts");
        this.listAccountLocal.setScrollBarEnabled(false);
        this.listAccountLocal.setContentSize(cc.size(cc.visibleRect.width, cc.visibleRect.height - this.buttonLocal.height));
    },

    initPanelOnline: function (node) {

        this.panelOnline = node.getChildByName("panel_online");
        this.panelOnline.setVisible(false);

        this.buttonOnline = node.getChildByName("button_online");
        this.buttonOnline.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 1)) {
                this.selectTab(this.TABS.ONLINE);
            }
        });

        this.buttonOnlineText = this.buttonOnline.getChildByName("text");

        this.panelLogin = this.panelOnline.getChildByName("panel_login");
        this.panelLogin.setScale(cc.visibleRect.height / 720);

        this.listAccountOnline = this.panelOnline.getChildByName("list_accounts");
        this.listAccountOnline.setScrollBarEnabled(false);
        this.listAccountOnline.setVisible(!this.usePortalLogin);
        this.listAccountOnline.setContentSize(cc.size(cc.visibleRect.width - this.panelLogin.width * this.panelLogin.getScale(), cc.visibleRect.height - this.buttonOnline.height));

        if (this.usePortalLogin)
            this.panelLogin.setPositionX(cc.visibleRect.center.x - this.panelLogin.width * this.panelLogin.getScale() * 0.5);

        this.inputFrameName = this.panelLogin.getChildByName("bg_input_name");
        this.inputFramePass = this.panelLogin.getChildByName("bg_input_pass");

        this.textName = this.inputFrameName.getChildByName("box").getChildByName("text_name");
        this.textName.setTextColor(this.TEXT_COLOR_PLACEHOLDER);
        this.textName.setString(portalHelper.getUserName());
        this.textName.setVisible(this.usePortalLogin);

        this.textPass = this.inputFramePass.getChildByName("box").getChildByName("text_pass");
        this.textPass.setTextColor(this.TEXT_COLOR_PLACEHOLDER);
        this.textPass.setString("******");
        this.textPass.setVisible(this.usePortalLogin);

        if (!this.usePortalLogin) {

            let inputMargin = 15;
            let inputFontSize = 28;
            let inputFontName = this.resourceRoot + "/fester_bold.ttf";

            let inputSize = this.inputFrameName.getContentSize();
            inputSize = cc.size(inputSize.width - inputMargin * 2, inputSize.height - 5);

            this.inputName = cc.EditBox.create(inputSize, this.resourceRoot + "/empty.png");
            this.panelLogin.addChild(this.inputName);

            this.inputName.setMaxLength(100);
            this.inputName.setFontName(inputFontName);
            this.inputName.setFontSize(inputFontSize);
            this.inputName.setFontColor(this.TEXT_COLOR_INPUT);
            this.inputName.setPlaceholderFontName(inputFontName);
            this.inputName.setPlaceholderFontSize(inputFontSize);
            this.inputName.setPlaceholderFontColor(this.TEXT_COLOR_PLACEHOLDER);
            this.inputName.setReturnType(cc.KEYBOARD_RETURNTYPE_DONE);
            this.inputName.setInputMode(cc.EDITBOX_INPUT_MODE_SINGLELINE);
            this.inputName.setInputFlag(cc.EDITBOX_INPUT_FLAG_SENSITIVE);
            this.inputName.setAnchorPoint(cc.ANCHOR_MIDDLE_LEFT());
            this.inputName.setPosition(cc.p(this.inputFrameName.x + inputMargin, this.inputFrameName.y - 5));
            this.inputName.setPlaceHolder("Enter username");
            this.inputName.setDelegate(this);

            this.inputPass = cc.EditBox.create(inputSize, this.resourceRoot + "/empty.png");
            this.panelLogin.addChild(this.inputPass);

            this.inputPass.setMaxLength(100);
            this.inputPass.setFontName(inputFontName);
            this.inputPass.setFontSize(inputFontSize);
            this.inputPass.setFontColor(this.TEXT_COLOR_INPUT);
            this.inputPass.setPlaceholderFontName(inputFontName);
            this.inputPass.setPlaceholderFontSize(inputFontSize);
            this.inputPass.setPlaceholderFontColor(this.TEXT_COLOR_PLACEHOLDER);
            this.inputPass.setReturnType(cc.KEYBOARD_RETURNTYPE_DONE);
            this.inputPass.setInputMode(cc.EDITBOX_INPUT_MODE_SINGLELINE);
            this.inputPass.setInputFlag(cc.EDITBOX_INPUT_FLAG_SENSITIVE);
            this.inputPass.setAnchorPoint(cc.ANCHOR_MIDDLE_LEFT());
            this.inputPass.setPosition(cc.p(this.inputFramePass.x + inputMargin, this.inputFramePass.y));
            this.inputPass.setPlaceHolder("Enter password");
            this.inputPass.setDelegate(this);
        }

        this.buttonLogin = this.panelLogin.getChildByName("button_login");
        this.buttonLogin.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                if (this.usePortalLogin) {
                    this.onOnlineSelected && this.onOnlineSelected(null, {socketType: this.panelSocket.value});
                } else {
                    let userName = this.inputName.getString();
                    let userPass = this.inputPass.getString();
                    if (userName.length > 0 && userPass.length > 0) {
                        portalHelper.setUserName(userName);
                        portalHelper.setUserPass(userPass);
                        this.loginOnlineNormal(portalHelper.getUserName(), portalHelper.getUserPassHash(), () => {
                            this.onOnlineSelected && this.onOnlineSelected(null, {socketType: this.panelSocket.value});
                        });
                    } else {
                        // TODO: Show error
                    }
                }
            }
        });

        this.buttonInstant = this.panelLogin.getChildByName("button_instant");
        this.buttonInstant.setVisible(!this.usePortalLogin);
        this.buttonInstant.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                this.loginOnlineInstant(() => {
                    this.onOnlineSelected && this.onOnlineSelected(null, {socketType: this.panelSocket.value});
                });
            }
        });
    },

    initPanelSetting: function (node) {

        this.buttonSetting = node.getChildByName("button_setting");
        this.buttonSetting.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                this.toggleSetting();
            }
        });

        this.panelSetting = node.getChildByName("panel_setting");
        NodeUtils.setNodeCascade(this.panelSetting, true, true);

        this.panelSetting.setVisible(false);
        this.panelSetting.isBusy = false;
        this.panelSetting.basePosition = this.panelSetting.getPosition();

        this.initPanelSettingRemote(this.panelSetting);
        this.initPanelSettingSocket(this.panelSetting);
        this.initPanelSettingLanguage(this.panelSetting);
    },

    initPanelSettingRemote: function (node) {

        this.panelRemote = node.getChildByName("panel_remote");
        this.panelRemote.isChecked = false;
        this.panelRemote.setVisible(false);
        this.panelRemote.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 1)) {
                this.panelRemote.isChecked = !this.panelRemote.isChecked;
                this.buttonRemote.loadTexture(this.resourceRoot + ((this.panelRemote.isChecked) ? "/switch_on.png" : "/switch_off.png"));
            }
        });

        this.buttonRemote = this.panelRemote.getChildByName("button_remote");
        this.buttonRemote.loadTexture(this.resourceRoot + "/switch_off.png");

        this.textRemote = this.panelRemote.getChildByName("text_remote");
    },

    initPanelSettingSocket: function (node) {

        this.panelSocket = node.getChildByName("panel_socket");
        this.panelSocket.textValue = this.panelSocket.getChildByName("text_value");
        this.panelSocket.textValue.setString("");

        this.panelSocket.items = [];

        let entries = [
            {name: "ws", value: KingSocketType.WS},
            {name: "raw", value: KingSocketType.TCP},
        ];

        entries.forEach((entry) => {
            let item = this.panelSocket.getChildByName(entry.name);
            if (item) {

                item.value = entry.value;
                item.text = item.getChildByName("text");
                item.check = item.getChildByName("check");
                item.addTouchEventListener((sender, type) => {
                    if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                        this.panelSocket.select(sender);
                    }
                });

                this.panelSocket.items.push(item);
            }
        });

        this.panelSocket.select = (target) => {

            if (typeof target === 'number') {
                target = this.panelSocket.items[target];
            }

            if (target) {
                this.panelSocket.value = target.value;
                this.panelSocket.items.forEach((item) => {
                    item.check && item.check.setSelected(item === target);
                });
                this.panelSocket.textValue.setString(target.text.getString());
            }
        };

        this.panelSocket.select(0);
    },

    initPanelSettingLanguage: function (node) {
        this.panelLang = node.getChildByName("panel_lang");
        this.panelLang.textValue = this.panelLang.getChildByName("text_value");
        this.panelLang.textValue.setString("");

        this.panelLang.items = {};

        // let excludeKeys = ["VI", "CAM", "CHINA", "MALAY", "THAI", "EN", "MY", "PH"];
        let excludeKeys = [];
        let langs = Object.keys(Localize.LANG).filter(key => excludeKeys.indexOf(key) < 0);

        for (let i = 0; i < 10; i++) {
            let item = this.panelLang.getChildByName(cc.formatStr("item_%d", i + 1));
            if (item) {
                item.text = item.getChildByName("text");
                item.check = item.getChildByName("check");
                item.visible = i < langs.length;
                if (i < langs.length) {

                    item.index = i;
                    item.value = Localize.LANG[langs[i]];
                    item.text.setString(langs[i]);
                    item.addTouchEventListener((sender, type) => {
                        if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                            this.panelLang.select(sender);
                        }
                    });

                    this.panelLang.items[item.value] = item;
                }
            } else {
                break;
            }
        }

        this.panelLang.select = (target) => {

            if (typeof target === 'number') {
                target = this.panelLang.items[target];
            }

            if (target) {
                this.panelLang.value = target.value;
                for (let key in this.panelLang.items) {
                    const item = this.panelLang.items[key];
                    item.check && item.check.setSelected(item === target);
                }
                this.panelLang.textValue.setString(target.text.getString());
            }

            let langCodes = {};
            langCodes[Localize.LANG_TYPE.VI] = "vi";
            langCodes[Localize.LANG_TYPE.KM] = "km";
            langCodes[Localize.LANG_TYPE.ZH] = "zh";
            langCodes[Localize.LANG_TYPE.TH] = "th";
            langCodes[Localize.LANG_TYPE.EN] = "en";
            langCodes[Localize.LANG_TYPE.MY] = "my";
            langCodes[Localize.LANG_TYPE.ML] = "ml";
            langCodes[Localize.LANG_TYPE.PH] = "ph";

            if (portalHelper._getLanguageStr === undefined)
                portalHelper._getLanguageStr = portalHelper.getLanguageStr;

            if (portalHelper._getLanguageType === undefined)
                portalHelper._getLanguageType = portalHelper.getLanguageType;

            portalHelper.getLanguageStr = () => langCodes[this.panelLang.value];
            portalHelper.getLanguageType = () => this.panelLang.value;
        };

        let langMap = {};
        langMap["vi"] = Localize.LANG_TYPE.VI;
        langMap["km"] = Localize.LANG_TYPE.KM;
        langMap["zh"] = Localize.LANG_TYPE.ZH;
        langMap["th"] = Localize.LANG_TYPE.TH;
        langMap["en"] = Localize.LANG_TYPE.EN;
        langMap["my"] = Localize.LANG_TYPE.MY;
        langMap["ml"] = Localize.LANG_TYPE.ML;
        langMap["ph"] = Localize.LANG_TYPE.PH;

        this.panelLang.select(langMap[portalHelper.getLanguageStr()] || Localize.LANG.EN);
    },

    initTabs: function (node) {

        this.activeTab = 0;
        this.tabs = this.tabs || [];

        this.tabs.push({
            index: this.TABS.LOCAL,
            panel: this.panelLocal,
            button: this.buttonLocal,
            buttonText: this.buttonLocalText,
        });

        this.tabs.push({
            index: this.TABS.ONLINE,
            panel: this.panelOnline,
            button: this.buttonOnline,
            buttonText: this.buttonOnlineText,
        });

        this.selectTab(this.TABS.LOCAL, true);
    },

    initButtons: function (node) {
        this.buttonBack = node.getChildByName("button_back");
        this.buttonBack.setVisible(!portalManager.isTemplate());
        this.buttonBack.addTouchEventListener((sender, type) => {
            if (this.applyPressedEffect(sender, type, 1, 1)) {
                portalHelper.returnLobbyScene(portalHelper.LOBBY_LOCATION.MAIN);
            }
        });
    },

    hide: function () {
        if (!this.isBusy) {
            this.isBusy = true;
            portalHelper.returnLobbyScene();
        }
    },

    toggleSetting: function () {
        if (this.panelSetting.isVisible())
            this.hideSetting();
        else
            this.showSetting();
    },

    showSetting: function () {

        if (this.panelSetting.isBusy)
            return;

        this.panelSetting.isBusy = true;

        let time = 0.4;
        let moveTo = new cc.EaseSineOut(cc.moveTo(time * 0.5, this.panelSetting.basePosition.x + 10, this.panelSetting.basePosition.y));
        let moveBack = new cc.EaseSineOut(cc.moveTo(time * 0.5, this.panelSetting.basePosition.x, this.panelSetting.basePosition.y));

        this.panelSetting.setPositionX(-this.panelSetting.basePosition.x - this.panelSetting.width);
        this.panelSetting.runAction(cc.sequence(cc.show(), moveTo, moveBack, cc.callFunc(() => {
            this.panelSetting.isBusy = false;
        })));

        this.buttonSetting.runAction(cc.rotateTo(time * 0.5, 60));
    },

    hideSetting: function () {

        if (this.panelSetting.isBusy)
            return;

        this.panelSetting.isBusy = true;

        let time = 0.4;
        let moveTo = new cc.EaseSineOut(cc.moveTo(time * 0.5, this.panelSetting.basePosition.x + 10, this.panelSetting.basePosition.y));
        let moveBack = new cc.EaseSineOut(cc.moveTo(time * 0.5, -this.panelSetting.basePosition.x - this.panelSetting.width, this.panelSetting.basePosition.y));

        this.panelSetting.runAction(cc.sequence(moveTo, moveBack, cc.hide(), cc.callFunc(() => {
            this.panelSetting.isBusy = false;
        })));

        this.buttonSetting.runAction(new cc.EaseSineOut(cc.rotateTo(time, 0)));
    },

    selectTab: function (index, force = false) {

        if (!force && index === this.activeTab)
            return;

        this.activeTab = index;
        this.tabs.forEach((tab) => {
            tab.panel.setVisible(tab.index === this.activeTab);
            tab.button.setBackGroundColor((tab.index === this.activeTab) ? this.TAB_COLOR_SELECTED : this.TAB_COLOR_NORMAL);
            tab.buttonText.setTextColor((tab.index === this.activeTab) ? cc.hexToColor("#1A1A1A") : cc.color.WHITE);
        });

        this.panelRemote.setVisible(this.activeTab === this.TABS.LOCAL);
    },

    loadAccount: function (list, accounts, local = false, touchEnable = true) {

        if (!list)
            return;

        list.removeAllItems();

        let itemRow = null;
        let itemPerRow = 0;

        let itemWidth = 0;
        let itemMarginX = 10;
        let itemMarginY = 10;
        accounts.forEach((user, index) => {

            let item = this.createAccountItem(user, local);
            item.isLocal = local;

            item.setTouchEnabled(touchEnable);
            item.addTouchEventListener((sender, type) => {

                if (this.applyPressedEffect(sender, type, 1, 0.9)) {
                    if (sender.isLocal) {
                        KingBeta.setRemote(this.panelRemote.isChecked);
                        this.onBetaSelected && this.onBetaSelected(sender.data, {socketType: this.panelSocket.value});
                        list.removeAllItems();
                        this.loadAccount(
                            this.listAccountLocal,
                            [
                                {
                                    userId: "GAME",
                                    userName: "LOANDING...",
                                    userEmail: "",
                                    userPass: ""
                                }
                            ]
                            , true
                            , false
                        );
                    } else {
                        portalHelper.setUserId(sender.data.userId);
                        portalHelper.setUserName(sender.data.userName);
                        portalHelper.setUserPass(sender.data.userPass);
                        this.loginOnlineNormal(portalHelper.getUserName(), portalHelper.getUserPassHash(), () => {
                            this.onOnlineSelected && this.onOnlineSelected(null, {socketType: this.panelSocket.value});
                        });
                    }
                }
            });

            if (itemPerRow <= 0) {
                itemWidth = item.width + itemMarginX * 2;
                itemPerRow = Math.floor(list.width / itemWidth);
                itemWidth = (list.width - itemMarginX * 2) / itemPerRow;
            }

            let itemIndex = index % itemPerRow;
            if (itemIndex === 0) {

                itemRow = new ccui.Widget();
                itemRow.setContentSize(cc.size(list.width, item.height + itemMarginY * 2));
                itemRow.setTouchEnabled(false);

                list.pushBackCustomItem(itemRow);
            }

            if (itemRow) {
                item.setAnchorPoint(cc.ANCHOR_CENTER());
                item.setPosition(cc.p(itemMarginX + (0.5 + itemIndex) * itemWidth, item.height * 0.5));
                itemRow.addChild(item);
            }
        });

        let botItem = new ccui.Widget();
        botItem.setContentSize(cc.size(list.width, itemMarginY * 2));
        list.pushBackCustomItem(botItem);
    },

    createAccountItem: function (user, local = false) {

        let jsonFile = this.resourceRoot + "/portal_account.json";
        let root = ccs.load(jsonFile).node;

        let item = root.getChildByName("item");
        item.removeFromParent();
        item.data = user;

        let textId = item.getChildByName("text_id");
        textId.setString(user.userId);

        let textName = item.getChildByName("text_name");
        textName.setString(user.userName);
        textName.setTextColor((local) ? this.ACC_NAME_COLOR_LOCAL : this.ACC_NAME_COLOR_ONLINE);

        NodeUtils.fixTextLayout(item);

        return item;
    },

    loginOnlineNormal: function (userName, userPass, callback = null) {
        WebService.loginV2(userName, userPass, (response) => {
            let result = response.Result || 0;
            if (result === 1) {
                if (response.Data) {
                    portalHelper.setUserId(response.Data.uid || 0);
                    portalHelper.setUserToken(response.Data.t || "");
                    callback && callback();
                } else {
                    callback && callback(new Error("Error while logging in normal mode"));
                }
            } else {
                callback && callback(new Error("Error while logging in normal mode"));
            }
        });
    },

    loginOnlineInstant: function (callback = null) {
        WebService.registerInstant((response) => {
            let result = response.Result || 0;
            if (result === 1) {
                if (response.Data) {
                    let userName = response.Data.username || "";
                    let userPass = response.Data.pass || "";
                    this.loginOnlineNormal(userName, userPass, callback);
                } else {
                    callback && callback(new Error("Error while logging in instant mode"));
                }
            } else {
                callback && callback(new Error("Error while logging in instant mode"));
            }
        });
    },

    applyPressedEffect: function (button, type, scale = 1.0, deltaScale = 0.8) {

        if (!button)
            return false;

        let scaleX = scale.x || scale;
        let scaleY = scale.y || scale;

        if (type === ccui.Widget.TOUCH_BEGAN) {
            button.setScale(scaleX, scaleY);
            button.runAction(cc.scaleTo(0.1, scaleX * deltaScale, scaleY * deltaScale));
            return false;
        } else if (type === ccui.Widget.TOUCH_MOVED) {
            return false;
        } else if (type === ccui.Widget.TOUCH_CANCELED) {
            button.setScale(scaleX * deltaScale, scaleY * deltaScale);
            button.runAction(cc.EaseBackOut.create(cc.scaleTo(0.3, scaleX, scaleY)));
            return false;
        }

        button.setScale(scaleX * deltaScale, scaleY * deltaScale);
        button.runAction(cc.EaseBackOut.create(cc.scaleTo(0.3, scaleX, scaleY)));

        return true;
    },

    editBoxReturn: function (sender) {

    },
});

var PharaohLoginScene = cc.class("PharaohLoginScene", cc.Scene, {
    ctor: function (onBetaSelected = null, onOnlineSelected = null) {
        this._super();
        this.addChild(new PharaohLoginLayer(onBetaSelected, onOnlineSelected));
    }
});
